-- // FULL SCRIPT FIXED MENU + HIGHLIGHT ESP // --
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UIS = game:GetService("UserInputService")
local player = Players.LocalPlayer

-- ===== valid keys =====
local validKeys = { abcd = true, abcdf = true, bpremium = true }

-- ===== states =====
local infJumpEnabled = false
local noclipEnabled = false
local wsEnabled = false
local hbAllEnabled = false
local hbEnemyEnabled = false
local espAllEnabled = false
local espEnemyEnabled = false

local originalProps = {} -- lưu HRP gốc

local function isEnemy(plr)
    if player.Team and plr.Team then
        return player.Team ~= plr.Team
    else
        return true
    end
end

-- ===== GUI =====
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "CustomMenu"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = player:WaitForChild("PlayerGui")

-- Key frame
local keyFrame = Instance.new("Frame", ScreenGui)
keyFrame.Size = UDim2.new(0,300,0,160)
keyFrame.Position = UDim2.new(0.5, -150, 0.5, -80)
keyFrame.BackgroundColor3 = Color3.fromRGB(40,40,40)

local keyBox = Instance.new("TextBox", keyFrame)
keyBox.Size = UDim2.new(0,200,0,36)
keyBox.Position = UDim2.new(0.5, -100, 0.25, 0)
keyBox.PlaceholderText = "Nhập key..."

local keyCheck = Instance.new("TextButton", keyFrame)
keyCheck.Size = UDim2.new(0,100,0,36)
keyCheck.Position = UDim2.new(0.5, -50, 0.65, 0)
keyCheck.Text = "Xác nhận"

local keyToggleBtn = Instance.new("TextButton", ScreenGui)
keyToggleBtn.Size = UDim2.new(0,100,0,36)
keyToggleBtn.Position = UDim2.new(0,10,0,10)
keyToggleBtn.Text = "Key Menu"

-- Main button (ẩn tới khi nhập key đúng)
local mainToggleBtn = Instance.new("TextButton", ScreenGui)
mainToggleBtn.Size = UDim2.new(0,100,0,36)
mainToggleBtn.Position = UDim2.new(1, -110, 0, 10)
mainToggleBtn.Text = "Main"
mainToggleBtn.Visible = false

-- Main frame
local mainFrame = Instance.new("Frame", ScreenGui)
mainFrame.Size = UDim2.new(0,400,0,320)
mainFrame.Position = UDim2.new(0.5, -200, 0.5, -160)
mainFrame.BackgroundColor3 = Color3.fromRGB(45,45,45)
mainFrame.Visible = false

local tabBar = Instance.new("Frame", mainFrame)
tabBar.Size = UDim2.new(1,0,0,40)
tabBar.BackgroundColor3 = Color3.fromRGB(35,35,35)

local pages = {}
local function makeTab(name, x)
    local b = Instance.new("TextButton", tabBar)
    b.Size = UDim2.new(0,120,1,0)
    b.Position = UDim2.new(0, x*120, 0, 0)
    b.Text = name
    local p = Instance.new("Frame", mainFrame)
    p.Size = UDim2.new(1,0,1,-40)
    p.Position = UDim2.new(0,0,0,40)
    p.BackgroundColor3 = Color3.fromRGB(60,60,60)
    p.Visible = false
    pages[name] = p
    b.MouseButton1Click:Connect(function()
        for _,v in pairs(pages) do v.Visible = false end
        p.Visible = true
    end)
    return p
end

local playerPage = makeTab("Player", 0)
local espPage = makeTab("ESP", 1)
local scriptPage = makeTab("Script", 2)

-- ===== Key check =====
keyCheck.MouseButton1Click:Connect(function()
    if validKeys[keyBox.Text] then
        keyFrame:Destroy()
        keyToggleBtn:Destroy()
        mainToggleBtn.Visible = true
    else
        keyBox.Text = "Sai key!"
    end
end)

keyToggleBtn.MouseButton1Click:Connect(function()
    keyFrame.Visible = not keyFrame.Visible
end)

mainToggleBtn.MouseButton1Click:Connect(function()
    mainFrame.Visible = not mainFrame.Visible
end)

-- ===== Tab Player =====
local function makeBtn(parent, txt, posY)
    local btn = Instance.new("TextButton", parent)
    btn.Size = UDim2.new(0,160,0,36)
    btn.Position = UDim2.new(0,10,0,posY)
    btn.Text = txt
    return btn
end

-- InfJump
local infBtn = makeBtn(playerPage, "InfJump: OFF", 10)
infBtn.MouseButton1Click:Connect(function()
    infJumpEnabled = not infJumpEnabled
    infBtn.Text = infJumpEnabled and "InfJump: ON" or "InfJump: OFF"
end)
UIS.JumpRequest:Connect(function()
    if infJumpEnabled and player.Character then
        local h = player.Character:FindFirstChildOfClass("Humanoid")
        if h then h:ChangeState(Enum.HumanoidStateType.Jumping) end
    end
end)

-- NoClip
local noclipBtn = makeBtn(playerPage, "NoClip: OFF", 60)
noclipBtn.MouseButton1Click:Connect(function()
    noclipEnabled = not noclipEnabled
    noclipBtn.Text = noclipEnabled and "NoClip: ON" or "NoClip: OFF"
end)

-- WalkSpeed
local wsText = Instance.new("TextBox", playerPage)
wsText.Size = UDim2.new(0,100,0,36)
wsText.Position = UDim2.new(0,10,0,110)
wsText.Text = "16"

local wsBtn = Instance.new("TextButton", playerPage)
wsBtn.Size = UDim2.new(0,140,0,36)
wsBtn.Position = UDim2.new(0,120,0,110)
wsBtn.Text = "WalkSpeed: OFF"
wsBtn.MouseButton1Click:Connect(function()
    wsEnabled = not wsEnabled
    wsBtn.Text = wsEnabled and "WalkSpeed: ON" or "WalkSpeed: OFF"
end)

RunService.Stepped:Connect(function()
    if noclipEnabled and player.Character then
        for _,part in ipairs(player.Character:GetDescendants()) do
            if part:IsA("BasePart") then part.CanCollide = false end
        end
    end
    if wsEnabled and player.Character then
        local h = player.Character:FindFirstChildOfClass("Humanoid")
        local val = tonumber(wsText.Text) or 16
        if h then h.WalkSpeed = val end
    end
end)

-- ===== Tab ESP =====
local hbSizeBox = Instance.new("TextBox", espPage)
hbSizeBox.Size = UDim2.new(0,100,0,36)
hbSizeBox.Position = UDim2.new(0,10,0,10)
hbSizeBox.Text = "5"

local function makeESPBtn(txt,posY,callback)
    local b = Instance.new("TextButton", espPage)
    b.Size = UDim2.new(0,180,0,36)
    b.Position = UDim2.new(0,10,0,posY)
    b.Text = txt..": OFF"
    local state = false
    b.MouseButton1Click:Connect(function()
        state = not state
        b.Text = txt..": "..(state and "ON" or "OFF")
        callback(state)
    end)
end

makeESPBtn("Hitbox All",60,function(st) hbAllEnabled=st end)
makeESPBtn("Hitbox Enemy",110,function(st) hbEnemyEnabled=st end)
makeESPBtn("ESP All",160,function(st) espAllEnabled=st end)
makeESPBtn("ESP Enemy",210,function(st) espEnemyEnabled=st end)

-- ===== Hitbox Functions =====
local function saveOriginal(plr)
    if not plr or not plr.Character then return end
    local hrp = plr.Character:FindFirstChild("HumanoidRootPart")
    if hrp and not originalProps[plr.UserId] then
        originalProps[plr.UserId] = {
            Size = hrp.Size,
            Transparency = hrp.Transparency,
            Material = hrp.Material,
            Color = hrp.Color,
            CanCollide = hrp.CanCollide
        }
    end
end

local function applyHitbox(plr, size)
    if not plr.Character then return end
    local hrp = plr.Character:FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    saveOriginal(plr)
    hrp.Size = Vector3.new(size,size,size)
    hrp.Transparency = 0.7
    hrp.Material = Enum.Material.Neon
    hrp.Color = Color3.fromRGB(0,255,0)
    hrp.CanCollide = false
end

local function resetHitbox(plr)
    if not plr.Character then return end
    local hrp = plr.Character:FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    local orig = originalProps[plr.UserId]
    if orig then
        hrp.Size = orig.Size
        hrp.Transparency = orig.Transparency
        hrp.Material = orig.Material
        hrp.Color = orig.Color
        hrp.CanCollide = orig.CanCollide
        originalProps[plr.UserId] = nil
    else
        hrp.Size = Vector3.new(2,2,1)
        hrp.Transparency = 0
        hrp.Material = Enum.Material.Plastic
        hrp.Color = Color3.fromRGB(163,162,165)
        hrp.CanCollide = true
    end
end

-- ===== ESP Highlight =====
local function addESP(plr, color)
    if not plr.Character then return end
    local hl = plr.Character:FindFirstChild("ESPHighlight")
    if not hl then
        hl = Instance.new("Highlight")
        hl.Name = "ESPHighlight"
        hl.FillTransparency = 1
        hl.OutlineTransparency = 0
        hl.Parent = plr.Character
    end
    hl.OutlineColor = color
end

local function removeESP(plr)
    if not plr.Character then return end
    local hl = plr.Character:FindFirstChild("ESPHighlight")
    if hl then hl:Destroy() end
end

-- Update loop
task.spawn(function()
    while true do
        local size = tonumber(hbSizeBox.Text) or 5
        for _,plr in ipairs(Players:GetPlayers()) do
            if plr ~= player and plr.Character then
                if hbAllEnabled then
                    applyHitbox(plr,size)
                elseif hbEnemyEnabled and isEnemy(plr) then
                    applyHitbox(plr,size)
                else
                    resetHitbox(plr)
                end
                if espAllEnabled then
                    addESP(plr, Color3.fromRGB(0,255,0))
                elseif espEnemyEnabled and isEnemy(plr) then
                    addESP(plr, Color3.fromRGB(255,0,0))
                else
                    removeESP(plr)
                end
            end
        end
        task.wait(0.25)
    end
end)

-- ===== Tab Script =====
local flyBtn = Instance.new("TextButton", scriptPage)
flyBtn.Size = UDim2.new(0,200,0,36)
flyBtn.Position = UDim2.new(0,10,0,10)
flyBtn.Text = "Load FlyGuiV3"
flyBtn.MouseButton1Click:Connect(function()
    loadstring(game:HttpGet("https://raw.githubusercontent.com/XNEOFF/FlyGuiV3/main/FlyGuiV3.txt"))()
end)

local datthBtn = Instance.new("TextButton", scriptPage)
datthBtn.Size = UDim2.new(0,200,0,36)
datthBtn.Position = UDim2.new(0,10,0,60)
datthBtn.Text = "DatTh Script"
datthBtn.MouseButton1Click:Connect(function()
    loadstring(game:HttpGet("https://raw.githubusercontent.com/LuaCrack/DatThg/refs/heads/main/DatThgV2"))()
end)

-- Default show Player tab
for _,p in pairs(pages) do p.Visible=false end
pages["Player"].Visible=true
