--// Key System
local validKeys = {"abcd","abcdf","bpremium"}
local keySavedFile = "my_saved_key.txt"

local player = game.Players.LocalPlayer
local UIS = game:GetService("UserInputService")
local HttpService = game:GetService("HttpService")

--// Load/Save Data
local saveFile = "menu_settings.json"
local settings = {
    infJump=false, noclip=false, walkspeed=false, walkspeedValue=16,
    hitboxAll=false, hitboxEnemy=false, espAll=false, espEnemy=false,
    hitboxSize=7
}

local function saveSettings()
    if writefile then
        writefile(saveFile, HttpService:JSONEncode(settings))
    end
end

local function loadSettings()
    if readfile and isfile and isfile(saveFile) then
        local ok, data = pcall(function()
            return HttpService:JSONDecode(readfile(saveFile))
        end)
        if ok and data then settings = data end
    end
end
loadSettings()

--// UI
local ScreenGui = Instance.new("ScreenGui", game.CoreGui)
local keyFrame = Instance.new("Frame", ScreenGui)
keyFrame.Size = UDim2.new(0,300,0,150)
keyFrame.Position = UDim2.new(0.5,-150,0.5,-75)
keyFrame.BackgroundColor3 = Color3.fromRGB(40,40,40)
local keyBox = Instance.new("TextBox", keyFrame)
keyBox.Size = UDim2.new(1,-20,0,40)
keyBox.Position = UDim2.new(0,10,0,20)
keyBox.PlaceholderText = "Nhập Key..."
local keyBtn = Instance.new("TextButton", keyFrame)
keyBtn.Size = UDim2.new(0.5,-15,0,40)
keyBtn.Position = UDim2.new(0,10,0,80)
keyBtn.Text = "Submit"
local closeKeyBtn = Instance.new("TextButton", keyFrame)
closeKeyBtn.Size = UDim2.new(0.5,-15,0,40)
closeKeyBtn.Position = UDim2.new(0.5,5,0,80)
closeKeyBtn.Text = "Đóng"

local mainFrame
local function createMainUI()
    mainFrame = Instance.new("Frame", ScreenGui)
    mainFrame.Size = UDim2.new(0,400,0,300)
    mainFrame.Position = UDim2.new(0.5,-200,0.5,-150)
    mainFrame.BackgroundColor3 = Color3.fromRGB(50,50,50)
    mainFrame.Visible = false

    local mainToggle = Instance.new("TextButton", ScreenGui)
    mainToggle.Size = UDim2.new(0,100,0,40)
    mainToggle.Position = UDim2.new(1,-110,0,10)
    mainToggle.Text = "Main"
    mainToggle.MouseButton1Click:Connect(function()
        mainFrame.Visible = not mainFrame.Visible
    end)

    local tabBtns = Instance.new("Frame", mainFrame)
    tabBtns.Size = UDim2.new(1,0,0,30)
    tabBtns.BackgroundColor3 = Color3.fromRGB(70,70,70)

    local content = Instance.new("Frame", mainFrame)
    content.Size = UDim2.new(1,0,1,-30)
    content.Position = UDim2.new(0,0,0,30)

    local function clearContent()
        for _,c in ipairs(content:GetChildren()) do c:Destroy() end
    end

    --// Player Tab
    local function playerTab()
        clearContent()
        local y = 10

        -- InfJump
        local infBtn = Instance.new("TextButton", content)
        infBtn.Size = UDim2.new(1,-20,0,30)
        infBtn.Position = UDim2.new(0,10,0,y)
        infBtn.Text = "InfJump: "..tostring(settings.infJump)
        infBtn.MouseButton1Click:Connect(function()
            settings.infJump = not settings.infJump
            infBtn.Text = "InfJump: "..tostring(settings.infJump)
            saveSettings()
        end)
        y=y+40

        -- NoClip
        local noclipBtn = Instance.new("TextButton", content)
        noclipBtn.Size = UDim2.new(1,-20,0,30)
        noclipBtn.Position = UDim2.new(0,10,0,y)
        noclipBtn.Text = "NoClip: "..tostring(settings.noclip)
        noclipBtn.MouseButton1Click:Connect(function()
            settings.noclip = not settings.noclip
            noclipBtn.Text = "NoClip: "..tostring(settings.noclip)
            saveSettings()
        end)
        y=y+40

        -- WalkSpeed
        local wsBtn = Instance.new("TextButton", content)
        wsBtn.Size = UDim2.new(1,-20,0,30)
        wsBtn.Position = UDim2.new(0,10,0,y)
        wsBtn.Text = "WalkSpeed: "..tostring(settings.walkspeed)
        wsBtn.MouseButton1Click:Connect(function()
            settings.walkspeed = not settings.walkspeed
            wsBtn.Text = "WalkSpeed: "..tostring(settings.walkspeed)
            saveSettings()
        end)
        y=y+35

        local wsBox = Instance.new("TextBox", content)
        wsBox.Size = UDim2.new(1,-20,0,30)
        wsBox.Position = UDim2.new(0,10,0,y)
        wsBox.Text = tostring(settings.walkspeedValue)
        wsBox.FocusLost:Connect(function()
            local n=tonumber(wsBox.Text)
            if n then settings.walkspeedValue=n saveSettings() end
        end)
        y=y+50

        -- Player List
        local plrFrame = Instance.new("ScrollingFrame", content)
        plrFrame.Size = UDim2.new(1,-20,1,-y-10)
        plrFrame.Position = UDim2.new(0,10,0,y)
        plrFrame.CanvasSize = UDim2.new(0,0,0,0)
        plrFrame.ScrollBarThickness=6

        local function refreshPlayers()
            plrFrame:ClearAllChildren()
            local yPos=0
            for _,p in ipairs(game.Players:GetPlayers()) do
                if p ~= player then
                    local btn = Instance.new("TextButton", plrFrame)
                    btn.Size = UDim2.new(1,-10,0,30)
                    btn.Position = UDim2.new(0,5,0,yPos)
                    btn.Text = p.Name
                    btn.MouseButton1Click:Connect(function()
                        local function getRoot(char)
                            return char:FindFirstChild("HumanoidRootPart")
                                or char:FindFirstChild("Torso")
                                or char:FindFirstChild("UpperTorso")
                                or char:FindFirstChild("LowerTorso")
                        end
                        if player.Character and getRoot(player.Character) and p.Character and getRoot(p.Character) then
                            local myRoot = getRoot(player.Character)
                            local targetRoot = getRoot(p.Character)
                            for i=1,5 do
                                task.spawn(function()
                                    pcall(function()
                                        myRoot.CFrame = targetRoot.CFrame + Vector3.new(0,7,0)
                                    end)
                                end)
                                task.wait(0.05)
                            end
                        end
                    end)
                    yPos=yPos+35
                end
            end
            plrFrame.CanvasSize=UDim2.new(0,0,0,yPos)
        end
        refreshPlayers()
        game.Players.PlayerAdded:Connect(refreshPlayers)
        game.Players.PlayerRemoving:Connect(refreshPlayers)
    end

    --// ESP Tab
    local function espTab()
        clearContent()
        local y=10

        -- Ô nhập Hitbox Size
        local hbBox = Instance.new("TextBox", content)
        hbBox.Size = UDim2.new(1,-20,0,30)
        hbBox.Position = UDim2.new(0,10,0,y)
        hbBox.Text = tostring(settings.hitboxSize or 7)
        hbBox.PlaceholderText = "Nhập kích thước Hitbox"
        hbBox.FocusLost:Connect(function()
            local n = tonumber(hbBox.Text)
            if n then
                settings.hitboxSize = n
                saveSettings()
            end
        end)
        y=y+40

        -- Nút Hitbox All
        local hitAll = Instance.new("TextButton", content)
        hitAll.Size=UDim2.new(1,-20,0,30)
        hitAll.Position=UDim2.new(0,10,0,y)
        hitAll.Text="Hitbox All: "..tostring(settings.hitboxAll)
        hitAll.MouseButton1Click:Connect(function()
            settings.hitboxAll=not settings.hitboxAll
            hitAll.Text="Hitbox All: "..tostring(settings.hitboxAll)
            saveSettings()
        end)
        y=y+40

        -- Nút Hitbox Enemy
        local hitEnemy = Instance.new("TextButton", content)
        hitEnemy.Size=UDim2.new(1,-20,0,30)
        hitEnemy.Position=UDim2.new(0,10,0,y)
        hitEnemy.Text="Hitbox Enemy: "..tostring(settings.hitboxEnemy)
        hitEnemy.MouseButton1Click:Connect(function()
            settings.hitboxEnemy=not settings.hitboxEnemy
            hitEnemy.Text="Hitbox Enemy: "..tostring(settings.hitboxEnemy)
            saveSettings()
        end)
        y=y+40

        -- Nút ESP All
        local espAll = Instance.new("TextButton", content)
        espAll.Size=UDim2.new(1,-20,0,30)
        espAll.Position=UDim2.new(0,10,0,y)
        espAll.Text="ESP All: "..tostring(settings.espAll)
        espAll.MouseButton1Click:Connect(function()
            settings.espAll=not settings.espAll
            espAll.Text="ESP All: "..tostring(settings.espAll)
            saveSettings()
        end)
        y=y+40

        -- Nút ESP Enemy
        local espEnemy = Instance.new("TextButton", content)
        espEnemy.Size=UDim2.new(1,-20,0,30)
        espEnemy.Position=UDim2.new(0,10,0,y)
        espEnemy.Text="ESP Enemy: "..tostring(settings.espEnemy)
        espEnemy.MouseButton1Click:Connect(function()
            settings.espEnemy=not settings.espEnemy
            espEnemy.Text="ESP Enemy: "..tostring(settings.espEnemy)
            saveSettings()
        end)
    end

    --// Script Tab
    local function scriptTab()
        clearContent()
        local y=10
        local fly=Instance.new("TextButton",content)
        fly.Size=UDim2.new(1,-20,0,30)
        fly.Position=UDim2.new(0,10,0,y)
        fly.Text="FlyGuiV3"
        fly.MouseButton1Click:Connect(function()
            loadstring(game:HttpGet("https://raw.githubusercontent.com/XNEOFF/FlyGuiV3/main/FlyGuiV3.txt"))()
        end)
        y=y+40
        local dat=Instance.new("TextButton",content)
        dat.Size=UDim2.new(1,-20,0,30)
        dat.Position=UDim2.new(0,10,0,y)
        dat.Text="DatTh Script"
        dat.MouseButton1Click:Connect(function()
            loadstring(game:HttpGet("https://raw.githubusercontent.com/LuaCrack/DatThg/refs/heads/main/DatThgV2"))()
        end)
        y=y+40
        local tp=Instance.new("TextButton",content)
        tp.Size=UDim2.new(1,-20,0,30)
        tp.Position=UDim2.new(0,10,0,y)
        tp.Text="Menu TP"
        tp.MouseButton1Click:Connect(function()
            loadstring(game:HttpGet("https://raw.githubusercontent.com/doanhvu339-ux/Fly/refs/heads/main/scripttp"))()
        end)
    end

    -- Tabs
    local function makeTab(name,func,xPos)
        local b=Instance.new("TextButton",tabBtns)
        b.Size=UDim2.new(0.33,0,1,0)
        b.Position=UDim2.new(xPos,0,0,0)
        b.Text=name
        b.MouseButton1Click:Connect(func)
    end
    makeTab("Player",playerTab,0)
    makeTab("ESP",espTab,0.33)
    makeTab("Script",scriptTab,0.66)

    -- InfJump Listener
    UIS.JumpRequest:Connect(function()
        if settings.infJump and player.Character then
            local h=player.Character:FindFirstChildOfClass("Humanoid")
            if h then h:ChangeState(Enum.HumanoidStateType.Jumping) end
        end
    end)

    -- NoClip Loop
    game:GetService("RunService").Stepped:Connect(function()
        if settings.noclip and player.Character then
            for _,part in ipairs(player.Character:GetDescendants()) do
                if part:IsA("BasePart") then
                    part.CanCollide=false
                end
            end
        end
    end)

    -- WalkSpeed Loop
    game:GetService("RunService").Heartbeat:Connect(function()
        if settings.walkspeed and player.Character and player.Character:FindFirstChildOfClass("Humanoid") then
            player.Character:FindFirstChildOfClass("Humanoid").WalkSpeed=settings.walkspeedValue
        end
    end)

    -- ESP & Hitbox Update
    game:GetService("RunService").Heartbeat:Connect(function()
        for _,p in ipairs(game.Players:GetPlayers()) do
            if p.Character and p~=player then
                local humanoid=p.Character:FindFirstChildOfClass("Humanoid")
                local root=p.Character:FindFirstChild("HumanoidRootPart")
                if humanoid and root then
                    if settings.hitboxAll or (settings.hitboxEnemy and p.Team~=player.Team) then
                        root.Size=Vector3.new(settings.hitboxSize or 7,settings.hitboxSize or 7,settings.hitboxSize or 7)
                        root.Transparency=0.7
                        root.BrickColor=BrickColor.new("Lime green")
                        root.Material=Enum.Material.ForceField
                        root.CanCollide=false
                    end
                    local hl=p.Character:FindFirstChild("Highlight") or Instance.new("Highlight",p.Character)
                    hl.FillTransparency=1
                    hl.OutlineColor=Color3.new(0,1,0)
                    if settings.espAll or (settings.espEnemy and p.Team~=player.Team) then
                        hl.Enabled=true
                    else
                        hl.Enabled=false
                    end
                end
            end
        end
    end)
end

--// Key System
keyBtn.MouseButton1Click:Connect(function()
    local k=keyBox.Text
    for _,v in ipairs(validKeys) do
        if k==v then
            keyFrame.Visible=false
            createMainUI()
            return
        end
    end
    keyBox.Text="Sai Key!"
end)
closeKeyBtn.MouseButton1Click:Connect(function()
    keyFrame.Visible=false
end)
