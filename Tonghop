-- ================== SCREENGUI ==================
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "MiniMenu"
ScreenGui.Parent = game.CoreGui

-- ================== BẢNG NHẬP KEY ==================
local keyFrame = Instance.new("Frame")
keyFrame.Size = UDim2.new(0, 300, 0, 120)
keyFrame.Position = UDim2.new(0.5, -150, 0.5, -60)
keyFrame.BackgroundColor3 = Color3.fromRGB(50,50,50)
keyFrame.Parent = ScreenGui

-- Nút đóng (X)
local closeBtn = Instance.new("TextButton")
closeBtn.Size = UDim2.new(0, 30, 0, 30)
closeBtn.Position = UDim2.new(1, -35, 0, 5)
closeBtn.Text = "X"
closeBtn.BackgroundColor3 = Color3.fromRGB(200,50,50)
closeBtn.TextColor3 = Color3.new(1,1,1)
closeBtn.Parent = keyFrame
closeBtn.MouseButton1Click:Connect(function()
    keyFrame.Visible = false
end)

-- Label hướng dẫn
local keyLabel = Instance.new("TextLabel")
keyLabel.Size = UDim2.new(1, -20, 0, 30)
keyLabel.Position = UDim2.new(0, 10, 0, 10)
keyLabel.Text = "Nhập Key:"
keyLabel.BackgroundTransparency = 1
keyLabel.TextColor3 = Color3.new(1,1,1)
keyLabel.TextScaled = true
keyLabel.Parent = keyFrame

-- TextBox nhập key
local keyBox = Instance.new("TextBox")
keyBox.Size = UDim2.new(1, -20, 0, 30)
keyBox.Position = UDim2.new(0, 10, 0, 50)
keyBox.PlaceholderText = "Nhập key ở đây"
keyBox.BackgroundColor3 = Color3.fromRGB(70,70,70)
keyBox.TextColor3 = Color3.new(1,1,1)
keyBox.Parent = keyFrame

-- Key hợp lệ
local validKeys = {["abc"]=true, ["bpremium"]=true}
local keyAccepted = false

-- ================== MENU 4 TAB ==================
local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.new(0, 350, 0, 420)
MainFrame.Position = UDim2.new(0.5, -175, 0.5, -210)
MainFrame.BackgroundColor3 = Color3.fromRGB(30,30,30)
MainFrame.Visible = false
MainFrame.Parent = ScreenGui

local header = Instance.new("Frame")
header.Size = UDim2.new(1,0,0,40)
header.BackgroundColor3 = Color3.fromRGB(40,40,40)
header.Parent = MainFrame

local titleLabel = Instance.new("TextLabel")
titleLabel.Size = UDim2.new(1,0,1,0)
titleLabel.Text = "MiniMenu"
titleLabel.TextColor3 = Color3.new(1,1,1)
titleLabel.BackgroundTransparency = 1
titleLabel.TextScaled = true
titleLabel.Parent = header

-- Tabs
local tabs = {"Main","Player","Combat","Script"}
local tabButtons = {}
local tabFrames = {}

for i, name in ipairs(tabs) do
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0, 80, 0, 30)
    btn.Position = UDim2.new(0, (i-1)*90 + 10, 0, 40)
    btn.Text = name
    btn.BackgroundColor3 = Color3.fromRGB(50,50,50)
    btn.TextColor3 = Color3.new(1,1,1)
    btn.Parent = MainFrame
    table.insert(tabButtons, btn)

    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1,0,1,-70)
    frame.Position = UDim2.new(0,0,0,70)
    frame.BackgroundTransparency = 1
    frame.Visible = false
    frame.Parent = MainFrame
    tabFrames[name] = frame
end
tabFrames["Main"].Visible = true

for i, btn in ipairs(tabButtons) do
    btn.MouseButton1Click:Connect(function()
        for name, frame in pairs(tabFrames) do
            frame.Visible = (name == btn.Text)
        end
    end)
end

-- ================== NÚT BẬT/TẮT MENU NGOÀI ==================
local toggleMenuBtn = Instance.new("TextButton")
toggleMenuBtn.Size = UDim2.new(0,120,0,40)
toggleMenuBtn.Position = UDim2.new(0,20,0,20)
toggleMenuBtn.Text = "[ON] Menu"
toggleMenuBtn.BackgroundColor3 = Color3.fromRGB(70,70,70)
toggleMenuBtn.TextColor3 = Color3.new(1,1,1)
toggleMenuBtn.Visible = false
toggleMenuBtn.Parent = ScreenGui

local menuVisible = true
toggleMenuBtn.MouseButton1Click:Connect(function()
    if keyAccepted then
        menuVisible = not menuVisible
        MainFrame.Visible = menuVisible
        toggleMenuBtn.Text = (menuVisible and "[ON] Menu" or "[OFF] Menu")
    end
end)

-- ================== HÀM TOGGLE THỰC SỰ ==================
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local player = game.Players.LocalPlayer

-- ESP
local espEnabled = false
local function updateESP(state)
    espEnabled = state
end

RunService.RenderStepped:Connect(function()
    if espEnabled then
        for _, p in pairs(game.Players:GetPlayers()) do
            if p ~= player and p.Character and not p.Character:FindFirstChild("ESP_Box") then
                local box = Instance.new("BoxHandleAdornment")
                box.Name = "ESP_Box"
                box.Adornee = p.Character:FindFirstChild("HumanoidRootPart")
                box.Size = Vector3.new(2,5,1)
                box.Color3 = Color3.fromRGB(0,255,0)
                box.Transparency = 0.5
                box.AlwaysOnTop = true
                box.Parent = p.Character
            end
        end
    else
        for _, p in pairs(game.Players:GetPlayers()) do
            if p.Character then
                local box = p.Character:FindFirstChild("ESP_Box")
                if box then box:Destroy() end
            end
        end
    end
end)

-- Noclip
local noclipEnabled = false
RunService.Stepped:Connect(function()
    if noclipEnabled then
        if player.Character then
            for _, part in pairs(player.Character:GetDescendants()) do
                if part:IsA("BasePart") then
                    part.CanCollide = false
                end
            end
        end
    end
end)

-- InfJump
local infJumpEnabled = false
UserInputService.JumpRequest:Connect(function()
    if infJumpEnabled then
        if player.Character and player.Character:FindFirstChildOfClass("Humanoid") then
            player.Character:FindFirstChildOfClass("Humanoid"):ChangeState(Enum.HumanoidStateType.Jumping)
        end
    end
end)

-- Speed
local speedValue = 50
local speedEnabled = false
local function updateSpeed(state)
    speedEnabled = state
    if player.Character and player.Character:FindFirstChildOfClass("Humanoid") then
        player.Character:FindFirstChildOfClass("Humanoid").WalkSpeed = (state and speedValue or 16)
    end
end

-- High Jump
local jumpPower = 100
local jumpEnabled = false
local function updateJump(state)
    jumpEnabled = state
    if player.Character and player.Character:FindFirstChildOfClass("Humanoid") then
        player.Character:FindFirstChildOfClass("Humanoid").JumpPower = (state and jumpPower or 50)
    end
end

-- ================== TAB COMBAT ==================
local combatFrame = tabFrames["Combat"]
local hitboxEnabled = false
local hitboxSize = 5

local hitboxToggle = Instance.new("TextButton")
hitboxToggle.Size = UDim2.new(0,200,0,30)
hitboxToggle.Position = UDim2.new(0,70,0,10)
hitboxToggle.Text = "[OFF] Hitbox"
hitboxToggle.BackgroundColor3 = Color3.fromRGB(70,70,70)
hitboxToggle.TextColor3 = Color3.new(1,1,1)
hitboxToggle.Parent = combatFrame

local function updateHitboxes(state)
    for _, p in pairs(game.Players:GetPlayers()) do
        if p ~= player and p.Character then
            local hrp = p.Character:FindFirstChild("HumanoidRootPart")
            if hrp then
                if state then
                    hrp.Size = Vector3.new(hitboxSize,hitboxSize,hitboxSize)
                    hrp.CanCollide = false
                    hrp.Transparency = 0.5
                else
                    hrp.Size = Vector3.new(2,2,1)
                    hrp.CanCollide = true
                    hrp.Transparency = 1
                end
            end
        end
    end
end

hitboxToggle.MouseButton1Click:Connect(function()
    hitboxEnabled = not hitboxEnabled
    hitboxToggle.Text = (hitboxEnabled and "[ON] Hitbox" or "[OFF] Hitbox")
    updateHitboxes(hitboxEnabled)
end)

local sizeBox = Instance.new("TextBox")
sizeBox.Size = UDim2.new(0,100,0,30)
sizeBox.Position = UDim2.new(0,70,0,50)
sizeBox.PlaceholderText = "Hitbox Size"
sizeBox.Text = tostring(hitboxSize)
sizeBox.BackgroundColor3 = Color3.fromRGB(50,50,50)
sizeBox.TextColor3 = Color3.new(1,1,1)
sizeBox.Parent = combatFrame

sizeBox.FocusLost:Connect(function()
    local num = tonumber(sizeBox.Text)
    if num and num>0 then
        hitboxSize = num
        if hitboxEnabled then updateHitboxes(true) end
    else
        sizeBox.Text = tostring(hitboxSize)
    end
end)

-- ================== TAB SCRIPT ==================
local scriptFrame = tabFrames["Script"]
local scriptLabel = Instance.new("TextLabel")
scriptLabel.Size = UDim2.new(0,200,0,50)
scriptLabel.Position = UDim2.new(0,70,0,10)
scriptLabel.Text = "Script: MiniMenu v1.0"
scriptLabel.BackgroundColor3 = Color3.fromRGB(50,50,50)
scriptLabel.TextColor3 = Color3.new(1,1,1)
scriptLabel.TextScaled = true
scriptLabel.Parent = scriptFrame

local flyBtn = Instance.new("TextButton")
flyBtn.Size = UDim2.new(0,200,0,30)
flyBtn.Position = UDim2.new(0,70,0,70)
flyBtn.Text = "Fly Script"
flyBtn.BackgroundColor3 = Color3.fromRGB(70,70,70)
flyBtn.TextColor3 = Color3.new(1,1,1)
flyBtn.Parent = scriptFrame
flyBtn.MouseButton1Click:Connect(function()
    loadstring(game:HttpGet("https://raw.githubusercontent.com/XNEOFF/FlyGuiV3/main/FlyGuiV3.txt"))()
end)

local datthBtn = Instance.new("TextButton")
datthBtn.Size = UDim2.new(0,200,0,30)
datthBtn.Position = UDim2.new(0,70,0,110)
datthBtn.Text = "DatTh Script"
datthBtn.BackgroundColor3 = Color3.fromRGB(70,70,70)
datthBtn.TextColor3 = Color3.new(1,1,1)
datthBtn.Parent = scriptFrame
datthBtn.MouseButton1Click:Connect(function()
    loadstring(game:HttpGet("https://raw.githubusercontent.com/LuaCrack/DatThg/refs/heads/main/DatThgV2"))()
end)

-- ================== TAB MAIN & PLAYER ==================
local mainFrame = tabFrames["Main"]
createToggle(mainFrame, "ESP", function(state) updateESP(state) end, 10)
createToggle(mainFrame, "Noclip", function(state) noclipEnabled = state end, 50)
createToggle(mainFrame, "Inf Jump", function(state) infJumpEnabled = state end, 90)

local playerFrame = tabFrames["Player"]
createToggle(playerFrame, "Speed", function(state) updateSpeed(state) end, 10)
createToggle(playerFrame, "High Jump", function(state) updateJump(state) end, 50)

-- ================== KÍCH HOẠT MENU SAU NHẬP KEY ==================
keyBox.FocusLost:Connect(function(enterPressed)
    if enterPressed then
        if validKeys[keyBox.Text] then
            keyFrame.Visible = false
            MainFrame.Visible = true
            toggleMenuBtn.Visible = true
            keyAccepted = true
        else
            keyBox.Text = ""
            print("Key sai!")
        end
    end
end)
